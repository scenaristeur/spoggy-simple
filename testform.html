<html>
<style>
input{
  width: 100%;
}

</style>
<script src="./js/import-export.js"></script>
<script src="./js/shex-browserify.min.js"></script>
<body>
  Transform shapes (<a href="https://forum.solidproject.org/t/blog-post-shaping-linked-data-apps/1914/11" taget="blank">shex to forms</a>)
  <form>
    <select id="mySelect">
      <!--<option>https://holacratie.solid.community/public/Schema/circle.shex</option>-->
      <!--  <option>http://shex.io/examples/Issue.shex</option>-->
      <option> CHOOSE AN HOLACRATIE SHEX </option>
      <option>https://holacratie.solid.community/public/Schema/role.shex</option>
      <option>https://holacratie.solid.community/public/Schema/tension.shex</option>
      <option>https://holacratie.solid.community/public/Schema/ratifier.shex</option>
      <option>https://holacratie.solid.community/public/Schema/accountability.shex</option>
      <option>https://holacratie.solid.community/public/Schema/capacity.shex</option>
      <option>https://holacratie.solid.community/public/Schema/circle.shex</option>
      <option>https://holacratie.solid.community/public/Schema/governance.shex</option>
      <option>  OTHER SHEX </option>
      <option>https://holacratie.solid.community/public/Schema/issue.shex</option>
      <option>https://jmartin.inrupt.net/public/shapes/book.shex</option>
      <option>https://jmartin.inrupt.net/public/shapes/movie.shex</option>
      <option>https://jmartin.inrupt.net/public/shapes/data-browser.shex</option>
      <option>https://jmartin.inrupt.net/public/shapes/employee.shex</option>
      <option>SHEX WITH PROBLEMS</option>
      <option>https://holacratie.solid.community/public/Schema/purpose.shex</option>
      <option>https://holacratie.solid.community/public/Schema/domain.shex</option>
      <option>YOUR SHEX</option>
    </select>

  </form>


  <input id="newShape"  placeholder="https://mypod.provider/public/shapes/shape.shex">https://holacratie.solid.community/public/Schema/xxxxxx.shex</input>
  <button onclick="add()"> add yours / ajoutez votre shape to the select (shex)</button>
  (<a href="http://shexspec.github.io/primer/">http://shexspec.github.io/primer/</a>)
  <br><br>
  <button onclick="charge()">Charger / Load V1</button>
  <button onclick="chargelib()">Charger / Load V2 with shex.js</button>
  <br>
  <br>


  <div id="forms">

  </div>

  <fieldset id="formulaire">
    <legend id="legend"></legend>
    <ul id="formlist">
      <li>Click on Load button to load a shape/form </li>
      <li>Click sur le bouton "charger" pour charger un shape/form </li>
    </ul>

  </fieldset>


</body>


<script>

function add(){
  var select = document.getElementById("mySelect")
  var option = document.createElement("option");
  option.text = document.getElementById("newShape").value.trim();
  select.add(option);
}

function chargelib(){
  var id = document.getElementById("mySelect").options.selectedIndex;
  var shapeUrl = document.getElementById("mySelect").options[id].text;
  //console.log(shapeUrl)
  //let url = params.source;
  /*  fetch(shapeUrl)
  .then(res => res.text())
  .then((out) => {
  console.log('Checkout this shex! ', out);

})
.catch(err => { throw err });*/
//  console.log(ShEx)
var shex = ShEx;
console.log(shex)
//var shexc = "https://jmartin.inrupt.net/public/shapes/book.shex";
//var data = "https://jmartin.inrupt.net/public/shapes/book.ttl";
//var node = "https://jmartin.inrupt.net/public/shapes/book";
shex.Loader.load([shapeUrl], [], [], []).then(function (loaded) {
  console.log("LOADED",loaded)
  //console.log("VALID",shex.Validator.construct(loaded.schema))
  if (loaded.schema){
    schemaToForm(loaded.schema)
  }else{
    alert("Impossible Error, not a valid schema")
  }

  //  var db = shex.Util.makeN3DB(loaded.data);
  //  var validator = shex.Validator.construct(loaded.schema, { results: "api" });
  //  var result = validator.validate(db, [{node: node, shape: shex.Validator.start}]);
  //  console.log(result);
});
}

function clear(){
  var liste = document.getElementById("formlist")
  liste.innerHTML = "";
  var dest = document.getElementById("forms")
  dest.innerHTML = ""
}


function schemaToForm(schema){
  console.log(schema)
  var br = document.createElement("br");
  var dest = document.getElementById("forms")
  clear();
  var prefixes = schema.prefixes;
  var shapes = schema.shapes;
  var start = schema.start;
  console.log ("start",start)
  for (let [url, constraint] of Object.entries(shapes)) {
    console.log("#################\n",url,constraint);
    var formDiv = document.createElement("div")
    formDiv.innerHTML = url;
    dest.appendChild(formDiv)

    var liste = document.createElement("ul")
    //  formDiv.innerHTML = url;
    dest.appendChild(liste)
    //  console.log(constraint.expression)
    console.log(constraint.expression.type)
    //  console.log(constraint.expression.expressions)
    var expressions = constraint.expression.expressions;
    expressions.forEach(function(exp){
      //  console.log(exp)
      var li = document.createElement("li");
      liste.appendChild(li)
      switch(exp.type) {
        case "TripleConstraint":
        console.log("===EXP==",exp.type,exp)
        // code block

        li.appendChild(document.createTextNode(exp.predicate));
        li.appendChild(br.cloneNode())
        li.appendChild(document.createTextNode(exp.type));
        li.appendChild(br.cloneNode())

        switch(exp.valueExpr.type) {
          case "NodeConstraint":
          // code block
          console.log("---VAL---",exp.valueExpr.type,exp.valueExpr)
          li.appendChild(document.createTextNode("EXPR TYPE :"+exp.valueExpr.type));
          li.appendChild(br.cloneNode())
          if (exp.valueExpr.values != undefined){
            li.appendChild(document.createTextNode("EXPR VALUES :"+exp.valueExpr.values));
            li.appendChild(br.cloneNode())
          }
          if (exp.valueExpr.datatype != undefined){
            li.appendChild(document.createTextNode("EXPR DATATYPE :"+exp.valueExpr.datatype));
            li.appendChild(br.cloneNode())
          }
          if (exp.valueExpr.nodeKind != undefined){
            li.appendChild(document.createTextNode("EXPR NODEKIND :"+exp.valueExpr.nodeKind));
            li.appendChild(br.cloneNode())
          }
          break;
          case "ShapeRef":
          // code block
          console.log("---VAL---",exp.valueExpr.type,exp.valueExpr)
          li.appendChild(document.createTextNode("EXPR TYPE :"+exp.valueExpr.type));
          li.appendChild(br.cloneNode())
          li.appendChild(document.createTextNode("SHAPE REF :"+exp.valueExpr.reference));
          li.appendChild(br.cloneNode())
          break;
          default:
          console.log("\n\nNON TRAITE---VAL---",exp.valueExpr.type,exp.valueExpr)
          li.appendChild(document.createTextNode("!!!TODO VAL TYPE:"+exp.valueExpr.type));
          li.appendChild(br.cloneNode())
        }
        break;
        case "EachOf":
        case "OneOf":
        console.log("===EXP==",exp.type,exp)
        li.appendChild(document.createTextNode(exp.type));
        li.appendChild(br.cloneNode())
        li.appendChild(document.createTextNode("min : "+exp.min+" max : "+exp.max ));
        li.appendChild(br.cloneNode())
        if(exp.expressions.length > 0){
          exp.expressions.forEach(function(subExp){
            li.appendChild(document.createTextNode(subExp.predicate));
            li.appendChild(br.cloneNode())
            li.appendChild(document.createTextNode("TODO DETAILLER valueExpr"));
            li.appendChild(br.cloneNode())
            console.log("A DETAILLER ", subExp.valueExpr)
          })
        }

        break;
        default:

        console.log("\n\nNON TRAITE===EXP=====",exp.type,exp)
        li.appendChild(document.createTextNode("!!!TODO EXP TYPE :"+exp.type));
        li.appendChild(br.cloneNode())
      }
    })


    /*var exp = constraint.expression.expressions;
    exp.forEach(function (e){
    console.log(e)
    var li = document.createElement("li");
    li.appendChild(document.createTextNode(e.predicate));
    li.appendChild(br.cloneNode())
    li.appendChild(document.createTextNode(e.type));
    console.log(e.valueExpr)*/
    /*switch (e.valueExpr.type) {
    case '#BASE':

    break;
    default:
    li.appendChild(br.cloneNode())
    li.appendChild(document.createTextNode("TODO "+e.valueExpr));
  }*/
  /*  if(e.valueExpr.nodeKind != undefined ) {
  li.appendChild(br.cloneNode()) ;
  li.appendChild(document.createTextNode(e.type));
}
if(e.valueExpr.datatype != undefined ) {
li.appendChild(br.cloneNode()) ;
li.appendChild(document.createTextNode(e.type));
}*/




//liste.appendChild(li)
/*  var br = document.createElement("br");
var li = document.createElement("li");
li.appendChild(document.createTextNode(e.predicate));
//  li.appendChild( document.createTextNode( '\u00A0' ) ); // ajout espace
li.appendChild(br.cloneNode())
switch(e.type) {
case "xsd:date":

break;
case "xsd:string":

break;
case "IRI":

break;
default:
console.log("Type non trait√© ",e)
}*/



//  })

//liste.appendChild(li)





}

}


function charge(){
  var id = document.getElementById("mySelect").options.selectedIndex;
  var shapeUrl = document.getElementById("mySelect").options[id].text;
  var params = {}
  console.log(shapeUrl)
  params.source = shapeUrl
  var destination = {}
  destination.headId = "legend"
  destination.listeId = "formlist"
  params.destination = destination;
  fetchShex(params,updateFormsTest);
}

function updateFormsTest(data){
  console.log("#################\nUPDATEFORMS TEST",data)
  start = data.start;
  destination = data.params.destination;
  document.getElementById(destination.headId).innerHTML = start
  forms = new Map();
  data.shapes.forEach(function(s){
    f = new Map();
    name = s.name;
    console.log(s.constraints)
    f.set(name, s.constraints)
    forms.set(name,f)

  })
  console.log(forms)
  createFormLines(forms,start,destination.listeId)
}


function createFormLines(forms, start,dest){
  console.log(forms, start, dest)
  clear();
  var liste = document.getElementById(dest)
  var current = forms.get(start)
  console.log("current",current)
  var it=current.entries();
  var constr = it.next().value[1]
  console.log("val", constr)
  constr.forEach(function(c){
    var numberOf = c.numberOf
    var elems = c.elems;
    console.log(c)
    var br = document.createElement("br");
    var li = document.createElement("li");
    li.appendChild(document.createTextNode(elems[0]));
    //  li.appendChild( document.createTextNode( '\u00A0' ) ); // ajout espace
    li.appendChild(br.cloneNode())

    if (elems[1] != undefined && elems[1].startsWith("[")){
      console.log("open set")
      var e = elems[1].substring(1);
      var selector = document.createElement("select")
      li.appendChild(selector);
      var optionSet1 = document.createElement("option");
      optionSet1.text = e.trim();
      selector.add(optionSet1);
      for (var i = 1; i < elems.length-1;i ++){
        e = elems[i];
        console.log("elem",e)
        var optionSet2 = document.createElement("option");
        optionSet2.text = e.trim();
        selector.add(optionSet2);
      }
    }
    else   if (elems[1] != undefined && elems[1].endsWith("]")){
      console.log("close set")
      e = elems[1].slice(0,-1);
      var optionSet = document.createElement("option");
      optionSet.text = e.trim();
      selector.add(optionSet);

    }else{

      switch(elems[1]) {
        case "xsd:dateTime":
        case "xsd:date":
        // code block
        var datepicker = document.createElement("input")
        datepicker.setAttribute("type", "date")

        li.appendChild(datepicker);
        break;
        case "xsd:string":
        var basicInput = document.createElement("input")
        basicInput.setAttribute("placeholder", "xsd:string")
        li.appendChild(basicInput);
        break;
        case "IRI":
        var iriInput = document.createElement("input")
        iriInput.setAttribute("placeholder", "IRI")
        li.appendChild(iriInput);
        break;
        default:
        li.appendChild(document.createTextNode(elems[1]));
      }
    }
    li.appendChild(br.cloneNode())
    //  li.appendChild( document.createTextNode( '\u00A0' ) );
    li.appendChild(document.createTextNode("nombre:"+numberOf));
    if (numberOf =="*"){
      li.appendChild(br.cloneNode())
      var addBtn = document.createElement("button");
      addBtn.innerHTML = "add one / ajouter un "+elems[1]
      li.appendChild(addBtn);

    }

    liste.appendChild(li);
    li.appendChild(br.cloneNode())





    li.appendChild(br.cloneNode())
  })
  var  submitBtn =document.createElement("button");
  submitBtn.innerHTML = "submit"
  liste.appendChild(submitBtn);
  /* creer tous les formulaires et les passer en display=none ?
  forms.forEach(function (f){
  console.log(f)
})*/

}


</script>


</html>
