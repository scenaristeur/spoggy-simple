<html>
<style>
input{
  width: 50%;
}
label {
  /* Other styling... */
  text-align: right;
  clear: both;
  float:left;
  margin-right:15px;
}

</style>
<script src="./js/import-export.js"></script>
<script src="./js/shex-browserify.min.js"></script>
<body>
  Transform shapes (<a href="https://forum.solidproject.org/t/blog-post-shaping-linked-data-apps/1914/11" taget="blank">shex to forms</a>)
  <form>
    <select id="mySelect">
      <!--<option>https://holacratie.solid.community/public/Schema/circle.shex</option>-->
      <!--  <option>http://shex.io/examples/Issue.shex</option>-->
      <option> CHOOSE AN HOLACRATIE SHEX </option>
      <option>https://holacratie.solid.community/public/Schema/role.shex</option>
      <option>https://holacratie.solid.community/public/Schema/tension.shex</option>
      <option>https://holacratie.solid.community/public/Schema/ratifier.shex</option>
      <option>https://holacratie.solid.community/public/Schema/accountability.shex</option>
      <option>https://holacratie.solid.community/public/Schema/capacity.shex</option>
      <option>https://holacratie.solid.community/public/Schema/circle.shex</option>
      <option>https://holacratie.solid.community/public/Schema/governance.shex</option>
      <option>  OTHER SHEX </option>
      <option>https://holacratie.solid.community/public/Schema/issue.shex</option>
      <option>https://holacratie.solid.community/public/Schema/example1.shex</option>
      <option>https://jmartin.inrupt.net/public/shapes/book.shex</option>
      <option>https://jmartin.inrupt.net/public/shapes/movie.shex</option>
      <option>https://jmartin.inrupt.net/public/shapes/data-browser.shex</option>
      <option>https://jmartin.inrupt.net/public/shapes/employee.shex</option>
      <option>SHEX WITH PROBLEMS</option>
      <option>https://holacratie.solid.community/public/Schema/purpose.shex</option>
      <option>https://holacratie.solid.community/public/Schema/domain.shex</option>
      <option>YOUR SHEX</option>
    </select>

  </form>


  <input id="newShape"  placeholder="https://mypod.provider/public/shapes/shape.shex">https://holacratie.solid.community/public/Schema/xxxxxx.shex</input>
  <button onclick="add()"> add yours / ajoutez votre shape to the select (shex)</button>
  (<a href="http://shexspec.github.io/primer/">http://shexspec.github.io/primer/</a>)
  <br><br>

  <button onclick="chargelib()">Charger / Load V2 with shex.js</button>
  <button onclick="charge()" disabled>Charger / Load V1</button>
  <br>
  <br>


  <div id="forms">

  </div>

  <fieldset id="formulaire">
    <legend id="legend"></legend>
    <ul id="formlist">
      <li>Select a Shape or add yours and select it after </li>
      <li>Click on Load button to load a shape/form </li>
      <li>Click sur le bouton "charger" pour charger un shape/form </li>
    </ul>

  </fieldset>


</body>


<script>
var dernierForm = "";
function add(){
  var select = document.getElementById("mySelect")
  var option = document.createElement("option");
  option.text = document.getElementById("newShape").value.trim();
  select.add(option);
}

function chargelib(){
  var id = document.getElementById("mySelect").options.selectedIndex;
  var shapeUrl = document.getElementById("mySelect").options[id].text;
  //console.log(shapeUrl)
  //let url = params.source;
  /*  fetch(shapeUrl)
  .then(res => res.text())
  .then((out) => {
  console.log('Checkout this shex! ', out);

})
.catch(err => { throw err });*/
//  console.log(ShEx)
var shex = ShEx;
console.log(shex)
//var shexc = "https://jmartin.inrupt.net/public/shapes/book.shex";
//var data = "https://jmartin.inrupt.net/public/shapes/book.ttl";
//var node = "https://jmartin.inrupt.net/public/shapes/book";
shex.Loader.load([shapeUrl], [], [], []).then(function (loaded, err) {
  console.log("LOADED",loaded)
  console.log("ERROR",err)
  //console.log("VALID",shex.Validator.construct(loaded.schema))
  if (loaded.schema){
    schemaToForm(loaded.schema)
  }else{
    alert("Impossible Error, not a valid schema")
  }

  //  var db = shex.Util.makeN3DB(loaded.data);
  //  var validator = shex.Validator.construct(loaded.schema, { results: "api" });
  //  var result = validator.validate(db, [{node: node, shape: shex.Validator.start}]);
  //  console.log(result);
});
}

function clear(){
  var liste = document.getElementById("formlist")
  liste.innerHTML = "";
  var dest = document.getElementById("forms")
  dest.innerHTML = ""
}


function schemaToForm(schema){
  console.log(schema)
  var br = document.createElement("br");
  var dest = document.getElementById("forms")
  clear();
  var prefixes = schema.prefixes;
  var shapes = schema.shapes;
  var start = schema.start;
  console.log(shapes)
  console.log ("start",start)
  for (let [url, constraint] of Object.entries(shapes)) {
    console.log("#################\n",url,constraint);
    var urlDiv = document.createElement("div")
    urlDiv.innerHTML = url;
    dest.appendChild(urlDiv)

    var formulaire = document.createElement("FORM")
    formulaire.setAttribute("id", url);
    dest.appendChild(formulaire)

    processExp(constraint,formulaire)


    /*
    var liste = document.createElement("ul")
    //  formDiv.innerHTML = url;
    formulaire.appendChild(liste)
    */

    //  console.log(constraint.expression)
    /*
    A REMETTRE POUR SHAPE

    console.log(constraint.expression.type)
    //  console.log(constraint.expression.expressions)
    var expressions = constraint.expression.expressions;
    expressions.forEach(function(exp){
    console.log("\nJSON :",exp)
    var li = document.createElement("li");
    liste.appendChild(li)

    li.appendChild(document.createElement("HR"));
    li.appendChild(document.createElement("HR"));
    li.appendChild(br.cloneNode())

    li.appendChild(document.createTextNode(JSON.stringify(exp, null, 2)));
    li.appendChild(br.cloneNode())
    li.appendChild(br.cloneNode())

    processExp(exp,li);



  });*/
  var submitBtn = document.createElement("BUTTON");
  var t = document.createTextNode("Submit");
  submitBtn.appendChild(t);
  submitBtn.onclick = function(){
    //  alert('here be dragons');
    testForm(url);
    return false;
  };
  formulaire.appendChild(submitBtn)
}
}



function processExp(exp,parent){
  var br = document.createElement("br");
  parent.appendChild(br.cloneNode())
  parent.appendChild(br.cloneNode())
  //  parent.appendChild(document.createTextNode(JSON.stringify(exp, null, 2)));
  //  parent.appendChild(br.cloneNode())

  switch (exp.type) {
    case "Shape":
    processShape(exp,parent)
    break;
    case "TripleConstraint":
    processTriple(exp,parent)
    break;
    case "NodeConstraint":
    processNode(exp,parent)
    break;
    case "EachOf":
    processEachOf(exp,parent)
    break;
    case "OneOf":
    processOneOf(exp,parent)
    break;
    case "ShapeRef":
    processShapeRef(exp,parent)
    break;
    case "ShapeOr":
    processShapeOr(exp,parent)
    break;

    default:
    parent.appendChild(document.createTextNode("TYPE INCONNU :"+JSON.stringify(exp, null, 2)));
    parent.appendChild(br.cloneNode())
  }
  parent.appendChild(br.cloneNode())
}

function processShape(exp,parent){
  var br = document.createElement("br");
  //  parent.appendChild(document.createTextNode("SHAPE "+ JSON.stringify(exp, null, 2)));
  //  parent.appendChild(br.cloneNode())
  processExp(exp.expression,parent)
}
function processTriple(exp,parent){
  var br = document.createElement("br");
  //  parent.appendChild(document.createTextNode("TRIPLE "+ JSON.stringify(exp, null, 2)));
  //  parent.appendChild(br.cloneNode())
  //  parent.appendChild(document.createTextNode("PREDICATE "+ exp.predicate));
  //  parent.appendChild(br.cloneNode())
  var labelInput = document.createElement("LABEL")
  labelInput.innerHTML = exp.predicate;
  parent.appendChild(labelInput);
  processExp(exp.valueExpr,parent)
}

function processEachOf(exp,parent){
  var br = document.createElement("br");
  //  parent.appendChild(document.createTextNode("EACHOF "+ JSON.stringify(exp, null, 2)));
  //  parent.appendChild(br.cloneNode())
  //  parent.appendChild(document.createTextNode("EXPRESSIONS "+ JSON.stringify(exp.expressions, null, 2)));
  exp.expressions.forEach(function(e){
    processExp(e,parent)
  });
}

function processOneOf(exp,parent){
  var br = document.createElement("br");
  parent.appendChild(document.createTextNode("ONEOF "+ JSON.stringify(exp, null, 2)));
}

function processNode(exp,parent){
  var br = document.createElement("br");
  parent.appendChild(document.createTextNode("NODE "+ JSON.stringify(exp, null, 2)));

  var elem;
  if(exp.datatype != undefined) {
    switch(exp.datatype) {
      case "http://www.w3.org/2001/XMLSchema#dateTime":
      case "http://www.w3.org/2001/XMLSchema#date":
      elem = document.createElement("input")
      elem.setAttribute("type", "date")
      break;
      case "http://www.w3.org/2001/XMLSchema#string":
      elem = document.createElement("input")
      elem.setAttribute("placeholder", "xsd:string")
      break;
      case "http://www.w3.org/2001/XMLSchema#integer":
      elem = document.createElement("input")
      elem.setAttribute("placeholder", "xsd:integer")
      elem.setAttribute("type", "number")
      break;
      default:
      //  elem = document.createTextNode(" !!!! DATATYPE INCONNU"+ JSON.stringify(exp, null, 2));
      elem = document.createElement("input")
      elem.setAttribute("placeholder", exp.datatype)
    }
    parent.appendChild(br.cloneNode());
  }
  // gestion des contraintes autres proprietes
  switch (true) {
    //exemple  <input type="number" name="quantity" min="1" max="5">
    case (exp.hasOwnProperty("values")):
    //  console.log("HAS VALUES ",exp.values)
    parent.appendChild(br.cloneNode())
    elem = document.createElement("select")
    parent.appendChild(elem);
    exp.values.forEach(function(v){
      var optionSet = document.createElement("option");
      optionSet.text = v.value || v;
      elem.add(optionSet);
    });
    break;
    case (exp.hasOwnProperty("minlength")):
    elem.setAttribute("minlength", exp.minlength)
    break;
    case (exp.hasOwnProperty("nodeKind")):
    if(exp.nodeKind == "iri" || exp.nodeKind == "IRI"){
      elem = document.createElement("input")
      elem.setAttribute("placeholder", "IRI")
    }else{
      parent.appendChild(document.createTextNode("NODEKIND Non géré"+ JSON.stringify(exp.nodeKind, null, 2)));

    }
    break;
  }
  parent.appendChild(elem);
  var expKeys =   Object.keys(exp)
  parent.appendChild(document.createTextNode("NODE KEYS"+ JSON.stringify(expKeys, null, 2)));
}

function processShapeRef(exp, parent){
  var shapeRefBtn = document.createElement("button")
  shapeRefBtn.innerHTML = "add one / ajouter un "+exp.reference;
  shapeRefBtn.onclick = function(){
    console.log("ID parent",parent.id)
    dernierForm = parent.id;
    var tousForms = document.querySelectorAll("form");
    console.log(tousForms)
    tousForms.forEach(function(f){
      console.log(f.id)
      if (f.id == exp.reference){
        f.style.display = "block"
      }else{
        f.style.display = "none"
      }
    })
    return false;
  };
  parent.appendChild(shapeRefBtn);
}



function processShapeOr(exp, parent){
  parent.appendChild(document.createTextNode("PROCESSSHAPEOR Non géré"+ JSON.stringify(exp, null, 2)));

  parent.appendChild(elem);
}



function testForm(id) {
  /*  var x = document.getElementById(id).elements.length;
  alert( "Found " + x + " elements in the form "+id);
  console.log(document.getElementById(id).elements)*/
  var tousForms = document.querySelectorAll("form");
  console.log(tousForms)
  tousForms.forEach(function(f){
    console.log(f.id)
    console.log("compare avec",dernierForm);
    if (f.id == dernierForm){
      f.style.display = "block"
    }else{
      f.style.display = "none"
    }
  });
}

function charge(){
  var id = document.getElementById("mySelect").options.selectedIndex;
  var shapeUrl = document.getElementById("mySelect").options[id].text;
  var params = {}
  console.log(shapeUrl)
  params.source = shapeUrl
  var destination = {}
  destination.headId = "legend"
  destination.listeId = "formlist"
  params.destination = destination;
  fetchShex(params,updateFormsTest);
}

function updateFormsTest(data){
  console.log("#################\nUPDATEFORMS TEST",data)
  start = data.start;
  destination = data.params.destination;
  document.getElementById(destination.headId).innerHTML = start
  forms = new Map();
  data.shapes.forEach(function(s){
    f = new Map();
    name = s.name;
    console.log(s.constraints)
    f.set(name, s.constraints)
    forms.set(name,f)

  })
  console.log(forms)
  createFormLines(forms,start,destination.listeId)
}


function createFormLines(forms, start,dest){
  console.log(forms, start, dest)
  clear();
  var liste = document.getElementById(dest)
  var current = forms.get(start)
  console.log("current",current)
  var it=current.entries();
  var constr = it.next().value[1]
  console.log("val", constr)
  constr.forEach(function(c){
    var numberOf = c.numberOf
    var elems = c.elems;
    console.log(c)
    var br = document.createElement("br");
    var li = document.createElement("li");
    li.appendChild(document.createTextNode(elems[0]));
    //  li.appendChild( document.createTextNode( '\u00A0' ) ); // ajout espace
    li.appendChild(br.cloneNode())

    if (elems[1] != undefined && elems[1].startsWith("[")){
      console.log("open set")
      var e = elems[1].substring(1);
      var selector = document.createElement("select")
      li.appendChild(selector);
      var optionSet1 = document.createElement("option");
      optionSet1.text = e.trim();
      selector.add(optionSet1);
      for (var i = 1; i < elems.length-1;i ++){
        e = elems[i];
        console.log("elem",e)
        var optionSet2 = document.createElement("option");
        optionSet2.text = e.trim();
        selector.add(optionSet2);
      }
    }
    else   if (elems[1] != undefined && elems[1].endsWith("]")){
      console.log("close set")
      e = elems[1].slice(0,-1);
      var optionSet = document.createElement("option");
      optionSet.text = e.trim();
      selector.add(optionSet);

    }else{

      switch(elems[1]) {
        case "xsd:dateTime":
        case "xsd:date":
        // code block
        var datepicker = document.createElement("input")
        datepicker.setAttribute("type", "date")

        li.appendChild(datepicker);
        break;
        case "xsd:string":
        var basicInput = document.createElement("input")
        basicInput.setAttribute("placeholder", "xsd:string")
        li.appendChild(basicInput);
        break;
        case "IRI":
        var iriInput = document.createElement("input")
        iriInput.setAttribute("placeholder", "IRI")
        li.appendChild(iriInput);
        break;
        default:
        li.appendChild(document.createTextNode(elems[1]));
      }
    }
    li.appendChild(br.cloneNode())
    //  li.appendChild( document.createTextNode( '\u00A0' ) );
    li.appendChild(document.createTextNode("nombre:"+numberOf));
    if (numberOf =="*"){
      li.appendChild(br.cloneNode())
      var addBtn = document.createElement("button");
      addBtn.innerHTML = "add one / ajouter un "+elems[1]
      li.appendChild(addBtn);

    }

    liste.appendChild(li);
    li.appendChild(br.cloneNode())





    li.appendChild(br.cloneNode())
  })
  var  submitBtn =document.createElement("button");
  submitBtn.innerHTML = "submit"
  liste.appendChild(submitBtn);
  /* creer tous les formulaires et les passer en display=none ?
  forms.forEach(function (f){
  console.log(f)
})*/

}


</script>


</html>
